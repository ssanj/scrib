<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Scrib!</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.0/css/bulma.min.css">
    <link rel="stylesheet" href="md.css">
    <script src="scrib-view.js"></script>
    <style>
      #notes-list {
        height: 20em;
        overflow: auto;
      }

      .autohide {
        visibility: visible;
        animation: autohide 3s;
        animation-fill-mode: forwards;
      }

      @keyframes autohide {
        from {visibilty: visible;}
        to {visibility: hidden}
      }
    </style>

  </head>
  <body>
  <div id="myapp"></div>
  <script>

      const appEditKey = 'scrib.edit';
      const appViewKey = 'scrib.view';
      const appApiKey  = 'scrib.api.key';

      const app = Elm.View.init({
        flags: initLoad(appViewKey),
        node: document.getElementById('myapp')
      });

      const markedOptions = {
        "gfm": true,
        "smartLists": true,
        "xhtml": true
      }

      function responseJson(eventType) {
        return {
          "eventType": eventType
        }
      }

      app.ports.scribMessage.subscribe(function(noteEvent){
        if (noteEvent.eventType === "save_message") {
          saveMessageToLocalStorage(noteEvent);
        } else if (noteEvent.eventType === "save_view_session") {
          saveToSessionStorage(noteEvent);
        } else if (noteEvent.eventType=== "preview_message") {
          previewMarkdown(noteEvent)
        } else if (noteEvent.eventType=== "remove_message") {
          console.log("clearing local storage");
          localStorage.removeItem(appEditKey);
          app.ports.jsMessage.send(responseJson("message_removed"));
        } else if (noteEvent.eventType=== "log_message_to_console") {
          console.log("output: " + JSON.stringify(noteEvent.output));
        } else {
          console.log("error, unknown noteEvent:" + JSON.stringify(noteEvent));
        }
      });

      function previewMarkdown(noteEvent) {
        const markdownView = document.getElementById('markdown-view');
        if (typeof marked !== 'undefined' && markdownView) {
          markdownView.innerHTML = marked(noteEvent.note.noteText, markedOptions);
        } else {
         console.log("error", "markdown renderer has not loaded.")
        }
      }

      function saveMessageToLocalStorage(noteEvent) {
        localStorage.setItem(appEditKey, JSON.stringify(noteEvent));
        console.log("you saved: " + JSON.stringify(noteEvent));
        app.ports.jsMessage.send(responseJson("message_saved"));
      }

      function saveToSessionStorage(noteEvent) {
        const viewData = JSON.stringify(noteEvent.view_data);
        sessionStorage.setItem(appViewKey, viewData);
        console.log("you saved your view: " + viewData);
      }

     function initLoad(appKey) {
      const storedData = sessionStorage.getItem(appKey);
      const notes      = storedData ? JSON.parse(storedData) : null;
      const apiKey     = localStorage.getItem(appApiKey);
      return { "notes" : notes, "apiKey" :  apiKey };
    }

  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/1.1.1/marked.min.js" integrity="sha512-KCyhJjC9VsBYne93226gCA0Lb+VlrngllQqeCmX+HxBBHTC4HX2FYgEc6jT0oXYrLgvfglK49ktTTc0KVC1+gQ==" crossorigin="anonymous"></script>
  </body>
</html>