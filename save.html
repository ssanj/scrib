<html>
<head>
  <meta charset="UTF-8">
  <title>Scrib</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.0/css/bulma.min.css">
  <link rel="stylesheet" href="md.css">
  <script src="scrib-save.js"></script>
  <style>
    .autohide {
      visibility: visible;
      animation: autohide 3s;
      animation-fill-mode: forwards;
    }

    @keyframes autohide {
      from {visibilty: visible;}
      to {visibility: hidden}
    }
  </style>
</head>

<body>
  <div id="myapp"></div>
  <script>

    const appEditKey = 'scrib.edit';

    const app = Elm.Save.init({
      flags: loadEditFromLocalStorage(appEditKey),
      node: document.getElementById('myapp')
    });

    const markedOptions = {
      "gfm": true,
      "smartLists": true,
      "xhtml": true
    }

    const markdownView = document.getElementById('markdown-view');

    app.ports.scribMessage.subscribe(function(noteEvent){
      if (noteEvent.eventType === "save_message") {
        saveMessageToLocalStorage(noteEvent);
      } else if (noteEvent.eventType=== "preview_message") {
        previewMarkdown(noteEvent)
      } else {
        console.log("error, unknown noteEvent:" + JSON.stringify(noteEvent));
      }
    });

    function loadEditFromLocalStorage(appKey) {
      const storedData = localStorage.getItem(appKey);
      return storedData ? JSON.parse(storedData) : null;
    }

    function previewMarkdown(noteEvent) {
      if (isDefined(marked) && isDefined(markdownView)) {
        markdownView.innerHTML = marked(noteEvent.noteText, markedOptions);
      } else {
        console.log("error", "markdown renderer has not loaded.")
      }
    }

    function isDefined(myVal) {
      return typeof myVal !== 'undefined'
    }

    function saveMessageToLocalStorage(noteEvent) {
      localStorage.setItem(appEditKey, JSON.stringify(noteEvent));
      console.log("you saved: " + JSON.stringify(noteEvent));
    }

  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/1.1.1/marked.min.js" integrity="sha512-KCyhJjC9VsBYne93226gCA0Lb+VlrngllQqeCmX+HxBBHTC4HX2FYgEc6jT0oXYrLgvfglK49ktTTc0KVC1+gQ==" crossorigin="anonymous"></script>
</body>
</html>